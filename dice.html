<!DOCTYPE html>
<html>
   <head>
      <title>Simulated Dice</title>
      <script type="text/javascript" src="./jquery-1.3.2.js"></script>
      <script type="text/javascript" src="./dice.js"></script>
      <script type="text/javascript">
      // <![CDATA[

      function createUUID() {
         // THIS IS NOT A REAL UUID!!!
         var s = [];
         var hexDigits = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
         for (var i = 0; i < 8; i++) {
            s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
         }
         s[12] = "4";
         s[16] = hexDigits.substr((s[16] & 0x3) | 0x8, 1);
         return s.join("");
      }
      
      var arolls;
      var dice;
      var roll_result;

      var mods;
      var min;
      var max;

      reset = function(){
          each_roll = new Array();
          dice = new Array();
          roll_result = new Array();

          mods = 0;
          min = 0;
          max = 0;
      }

      $(function(){

         reset();
         var form = $("#rolling_form");
         var result_header = $("#result h2");
         var input_roll = $("#txt_roll");

         $("#do_roll").click(function(){
            
            r = new roll($("#txt_roll"));
            r.roll();

            var uuid = createUUID();
            result_header.after("<div class=\"result\" id=\"" + uuid + "\"><h3>" + r.name + "</h3></div>");

            var result_container = $("#" + uuid);

            console.log(r.groups);
            
            for (var a in r.groups) {

               var group = r.groups[a];

               result_container.append("<fieldset><legend>" + 
                  group.name + 
                  "</legend><ul></ul></fieldset>");

               var result_group = result_container
               .children("fieldset:last-child")
               .children("ul");

               for(var b in group.result()) {
                  var d = group.dice[b];

                  if(group.dice.length >1) {
                     var item = $("<li class=\"d" + d.sides + "\">")
                        .hide().html(d.result);
                     result_group.append(item);
                  }
                  if(b == (group.dice.length -1)) {
                     item = $("<li class=\"total\">").hide().html(group.sum());
                     result_group.append(item);
                  }
               }
            }

            var sub_total = $("<ul>").append($("<li class=\"sub total\">").hide().html(r.subtotal()));
            var grand_total = $("<ul>").append($("<li class=\"grand total\">").hide().html(r.sum()));

            result_container.append(sub_total);
            result_container.append(grand_total);

            lis = $("#" + uuid + " li");
            function outer(){
               var a = -1;
               function inner() {
                  if(a === lis.length){return;}
                  a++;
                  lis.eq(a).fadeIn(100, function(){
                     $(this).animate({opacity:1.0}, 1000, function(){
                        fader();
                     });
                  });
               }
               return inner;
            }
            var fader = outer();
            fader();
            
            reset();
         });

      });
      // ]]>
      </script>

      <style type="text/css" media="screen">
         /* <![CDATA[ */
         
         div { clear:left; }
         fieldset {
            float:left;
         }
         ul { margin:0;padding:0; }
         li { 
            float:left;
            display:block;
            list-style:none;
            padding: 4px 8px;
            margin: 2px;
            border: 1px solid #ccc;
            color: #333;
         }
         li.total {
            margin-left: 20px;
            background-color: #C2FFAF;
         }
         /* ]]> */
      </style>

   </head>
   <body>

      <fieldset>
         <legend>Dice Simulator</legend>
            <p>
               <label for="txt_roll">Roll:</label>
               <input id="txt_roll" name="roll" />
            </p>
            <p>
               <input type="submit" value="Roll" id="do_roll"/>
            </p>
      </fieldset>

      <div id="result">
         <h2>Results:</h2>
      </div>

   </body>
</html>
