<!DOCTYPE html>
<html>
   <head>
      <title>Simulated Dice</title>
      <script type="text/javascript" src="./jquery-1.3.2.js"></script>
      <script type="text/javascript" src="./dice.js"></script>
      <script type="text/javascript">
      // <![CDATA[

      function createUUID() {
         // THIS IS NOT A REAL UUID!!!
         var s = [];
         var hexDigits = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
         for (var i = 0; i < 8; i++) {
            s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
         }
         s[12] = "4";
         s[16] = hexDigits.substr((s[16] & 0x3) | 0x8, 1);
         return s.join("");
      }
      
      var arolls;
      var dice;
      var roll_result;

      var mods;
      var min;
      var max;

      reset = function(){
          each_roll = new Array();
          dice = new Array();
          roll_result = new Array();

          mods = 0;
          min = 0;
          max = 0;
      }

      $(function(){

         reset();
         var form = $("#rolling_form");
         var result = $("#result");
         var input_roll = $("#txt_roll");

         $("#do_roll").click(function(){
            
            r = new roll($("#txt_roll"));
            r.roll();

            var uuid = createUUID();
            result.prepend("<div class=\"result_wrapper\"><div class=\"result\" id=\"" + uuid + "\"><h3>" + r.name + "</h3></div><br style=\"clear:both;\" /></div>");

            var result_container = $("#" + uuid);

            console.log(r.groups);
            
            for (var a in r.groups) {

               var group = r.groups[a];

               result_container.append($("<h4>").html(group.name)); 
               result_container.append($("<p>")); 

               var result_group = result_container
               .children("p:last-child");

               for(var b in group.result()) {
                  var d = group.dice[b];

                  if(group.dice.length >1) {
                     var item = $("<span class=\"d" + d.sides + "\">")
                        .hide().html(d.result);
                     result_group.append(item);
                  }
                  if(b == (group.dice.length -1)) {
                     eq = $("<span class=\"operator\">").hide().html("=");
                     item = $("<span class=\"total\">")
                        .hide()
                        .html(group.sum());
                     result_group.append(eq);
                     result_group.append(item);
                  }
               }
            }

            if(r.mods.length > 0) {
               var sub_total = $("<p>")
                  .append($("<span class=\"sub total\">")
                  .hide().html(r.subtotal()));
               result_container.append(sub_total);
            }

            var grand_total = $("<p>")
               .append($("<h4>").html("Total")) 
               .append($("<span class=\"grand total\">")
               .hide().html(r.sum()));
            result_container.append(grand_total);

            lis = $("#" + uuid + " span");
            function outer(){
               var a = -1;
               function inner() {
                  if(a === lis.length){return;}
                  a++;
                  lis.eq(a).fadeIn(400, function(){

                     if($(this).hasClass("operator")) {
                        fader();
                     } else {
                        $(this).animate({opacity:1.0}, 600, function(){
                           fader();
                        });
                     }

                  });
               }
               return inner;
            }
            var fader = outer();
            fader();
            
            reset();
         });

         $("#d20").click(function(){
            $("#txt_roll").val("1d20"); 
            $("#do_roll").click();
         });

      });
      // ]]>
      </script>

      <style type="text/css" media="screen">
         @import url('./reset.css'); 
         @import url('./dice.css'); 
      </style>

   </head>
   <body>

      <div id="container">

         <fieldset id="simulator">
            <input id="txt_roll" name="roll" />
            <input type="submit" value="Roll" id="do_roll"/>
         </fieldset>
         <a id="d20" class="d20" href="#"><span class="d20">20</span></a>

         <div id="result"></div>

      </div>

   </body>
</html>
